---
- name: Stat the plugin directory
  stat:
    path: "{{ redmine_home }}/plugins/{{ item.base_name }}"
  register: plugin_directory_stat

- name: Download plugin
  get_url:
    url: "{{ item.url }}"
    dest: "{{ redmine_home }}/plugins/"
  when: plugin_directory_stat.stat.exists == False
  register: plugin_download

- name: show plugin_download
  debug:
    msg: "{{ plugin_download }}"
  when: plugin_directory_stat.stat.exists == False

- name: Extract plugin
  unarchive:
    remote_src: yes
    dest: "{{ redmine_home }}/plugins/"
    src: "{{ plugin_download.dest }}"
  when: plugin_directory_stat.stat.exists == False

- name: Plugins migrate
  shell: RAILS_ENV=production /home/redmine/bin/bundle exec /home/redmine/bin/rake redmine:plugins:migrate
  args:
    chdir: "{{ redmine_home }}"
